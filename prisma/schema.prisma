generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

//////////////////////////
// SALON
//////////////////////////

model Salon {
  id           String   @id @default(uuid())
  name         String
  city         String
  businessType String   @default("salon")
  createdAt    DateTime @default(now())

  users        User[]
  staff        Staff[]
  services     Service[]
  sales        Sale[]
  payrolls     Payroll[]
  expenses     Expense[]
  appointments Appointment[]
  invoices     Invoice[]
  counter      Counter?

  // Restaurant
  restaurantTables  RestaurantTable[]
  menuItems         MenuItem[]
  restaurantOrders  RestaurantOrder[]
}

//////////////////////////
// USER
//////////////////////////

model User {
  id          String   @id @default(uuid())
  name        String
  email       String   @unique
  password    String
  role        String   @default("owner")    // "owner" | "staff"
  salonId     String

  // ── Staff-specific fields ──
  staffRole   String?                       // waiter, cashier, chef, manager, stylist, receptionist, store_manager, etc.
  permissions String?                       // JSON array of permission strings
  isActive    Boolean  @default(true)
  createdBy   String?                       // owner's userId who created this staff
  createdAt   DateTime @default(now())

  salon       Salon    @relation(fields: [salonId], references: [id])
}

//////////////////////////
// STAFF
//////////////////////////

model Staff {
  id               String   @id @default(uuid())
  name             String
  phone            String?
  commissionType   String
  commissionValue  Float
  baseSalary       Float?
  salonId          String

  // ── Role-based auth fields ──
  role             String   @default("staff")       // owner, manager, waiter, cashier, kitchen, staff
  pinHash          String?                           // bcrypt hashed 4-6 digit PIN
  permissions      String?                           // JSON array of permission strings
  isActive         Boolean  @default(true)
  lastLoginAt      DateTime?
  failedAttempts   Int      @default(0)
  lockedUntil      DateTime?

  salon     Salon      @relation(fields: [salonId], references: [id])
  items     SaleItem[]
  payrolls  Payroll[]

  @@index([salonId])
}

//////////////////////////
// SERVICE
//////////////////////////

model Service {
  id          String   @id @default(uuid())
  name        String
  price       Float
  costPrice   Float?
  duration    Int?
  description String?
  salonId     String

  salon   Salon      @relation(fields: [salonId], references: [id])
  items   SaleItem[]

  @@index([salonId])
}

//////////////////////////
// SALE
//////////////////////////

model Sale {
  id            String     @id @default(uuid())
  invoiceNo     String
  salonId       String
  date          DateTime   @default(now())
  subtotal      Float
  taxAmount     Float
  discount      Float      @default(0)
  totalAmount   Float
  paymentMode   String
  paymentStatus String     @default("paid")

  salon   Salon      @relation(fields: [salonId], references: [id])
  items   SaleItem[]

  @@index([salonId])
  @@unique([salonId, invoiceNo])
}

//////////////////////////
// SALE ITEM
//////////////////////////

model SaleItem {
  id         String   @id @default(uuid())
  saleId     String
  serviceId  String
  staffId    String
  price      Float
  commission Float
  quantity   Int      @default(1)

  sale    Sale    @relation(fields: [saleId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])
  staff   Staff   @relation(fields: [staffId], references: [id])

  @@index([saleId])
  @@index([staffId])
}

//////////////////////////
// PAYROLL
//////////////////////////

model Payroll {
  id              String   @id @default(uuid())
  salonId         String
  staffId         String
  month           Int
  year            Int

  totalServices   Int
  totalRevenue    Float
  totalCommission Float

  baseSalary      Float
  bonus           Float     @default(0)
  deductions      Float     @default(0)
  finalPayable    Float

  paymentStatus   String    @default("pending")
  paidAmount      Float     @default(0)

  createdAt       DateTime  @default(now())

  salon   Salon  @relation(fields: [salonId], references: [id])
  staff   Staff  @relation(fields: [staffId], references: [id])

  @@unique([salonId, staffId, month, year])
  @@index([salonId])
}

//////////////////////////
// EXPENSE
//////////////////////////

model Expense {
  id        String   @id @default(uuid())
  salonId   String
  title     String
  amount    Float
  category  String
  date      DateTime @default(now())

  salon     Salon    @relation(fields: [salonId], references: [id])

  @@index([salonId])
}
model Counter {
  id        String  @id @default(uuid())
  salonId   String  @unique
  saleCount Int     @default(0)

  salon     Salon   @relation(fields: [salonId], references: [id])
}

//////////////////////////
// APPOINTMENT
//////////////////////////

model Appointment {
  id            String   @id @default(uuid())
  salonId       String
  customerName  String
  customerPhone String?
  serviceId     String?
  staffId       String?
  date          DateTime
  time          String?
  status        String   @default("pending")
  notes         String?
  createdAt     DateTime @default(now())

  salon         Salon    @relation(fields: [salonId], references: [id])

  @@index([salonId])
}

//////////////////////////
// RESTAURANT TABLE
//////////////////////////

model RestaurantTable {
  id              String   @id @default(uuid())
  salonId         String
  name            String
  seats           Int      @default(4)
  status          String   @default("empty")   // empty, occupied, reserved, cleaning
  currentOrderId  String?
  customerName    String?
  occupiedSince   DateTime?
  createdAt       DateTime @default(now())

  salon           Salon    @relation(fields: [salonId], references: [id])

  @@index([salonId])
}

//////////////////////////
// MENU ITEM
//////////////////////////

model MenuItem {
  id          String   @id @default(uuid())
  salonId     String
  name        String
  category    String   @default("Uncategorized")
  price       Float
  isVeg       Boolean  @default(true)
  isAvailable Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())

  salon       Salon    @relation(fields: [salonId], references: [id])
  orderItems  RestaurantOrderItem[]

  @@index([salonId])
}

//////////////////////////
// RESTAURANT ORDER
//////////////////////////

model RestaurantOrder {
  id                String   @id @default(uuid())
  salonId           String
  tableId           String?
  tableName         String?
  waiterId          String?
  waiterName        String?
  type              String   @default("dine_in")  // dine_in, takeaway, delivery
  status            String   @default("Created")
  customerCount     Int      @default(1)
  customerName      String?
  customerPhone     String?
  subtotal          Float    @default(0)
  taxRate           Float    @default(0.05)
  serviceChargeRate Float    @default(0)
  discountAmount    Float    @default(0)
  cancelReason      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  salon             Salon    @relation(fields: [salonId], references: [id])
  items             RestaurantOrderItem[]

  @@index([salonId])
  @@index([salonId, status])
}

//////////////////////////
// RESTAURANT ORDER ITEM
//////////////////////////

model RestaurantOrderItem {
  id              String    @id @default(uuid())
  orderId         String
  menuItemId      String
  name            String
  price           Float
  isVeg           Boolean   @default(true)
  qty             Int       @default(1)
  note            String?
  status          String    @default("Pending")
  statusUpdatedAt DateTime?

  order           RestaurantOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem        MenuItem        @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
}

//////////////////////////
// INVOICE
//////////////////////////

model Invoice {
  id            String   @id @default(uuid())
  salonId       String
  customerName  String
  customerPhone String?
  items         String?
  total         Float    @default(0)
  status        String   @default("unpaid")
  date          DateTime @default(now())
  createdAt     DateTime @default(now())

  salon         Salon    @relation(fields: [salonId], references: [id])

  @@index([salonId])
}
